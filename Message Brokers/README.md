КАФКА

Брокер сообщений - программа, позволяющая отправлять сообщения между микросервисами и гарантирующая доставку сообщения адресату.

Основые элементы:
1. Продюсер - тот кто отправляет сообщение в МБ (не ждет ответа)
2. Месседж брокер - сохраняет сообщение и гарантирует доставку сообщения консюмеру
3. Консюмер - забирает данные из МБ данные, когда ему это нужно

Преимущества МБ:
1. Если консюмер упал во время выполнения обработки сообщения, то он сможет снова прийти к МБ и забрать еще раз.  
2. При появлении новых консюмеров не нужно изменять код продюсера, т.к. новый консюмер просто подписывается на новый топик на МБ
3. Позволяет масштабироваться до бесконечности путем добавления новых серверов и обеспечения параллельной обработки данных.


Как работает кафка:
1. Состоит из топиков (тем) - по факту канал для сообщений определенного типа (например, комментарии к посту).
Каждый микросервис может быть как продюсером для одного топика, так и консюмером для другого топика.

2.Гарантии доставки:
Кафку при запуске можно настроить так, чтобы гарантировать доставку сообщений. 
Виды гарантий:
 2.1. AT MOST ONCE - Доставить МАКСИМУМ один раз (т.е. либо 1 раз, либо 0)
  При такой настройке в случае ошибки при передаче от продюсера к кафке (или от кафки к консюмеру) сообщения, оно может потеряться
  Юз кейс: если не нужно гарантировать доставку данных (какие-нибудь не суперважные логи для отслеживания паттернов)
  
 2.2. AT LEAST ONCE
  Любое сообщение будет доставлено минимум один раз
  2.2.1. Когда мы передаем данные от продюсера кафке, то продюсер будет какое-то время ждать от кафки подтверждения получения (acknoledgement)
    Acknoledgement получается когда кафка получила и сохранила сообщение у себя на жесткий диск
    Если acknolegement не получен, то продюсер отправит сообщение в кафку еще раз
  2.2.2.
    Проблема в том, что одно и то же сообщение может дублироваться, если произошла ошибка сети при возврате акноледжмента на продюсер. Соответсвенно, консюмер получит два сообщения.
    ПРИ ТАКОЙ НАСТРОЙКЕ НЕОБХОДИМО УБЕДИТЬСЯ, ЧТО НА КОНСЮМЕРЕ НАСТРОЕН ФИЛЬТР ДУБЛИКАТОВ. 
    Это называется идемпотентный консюмер, т.е. консюмер, умеющий работать с дубликатами сообщений так, как если бы это было одно сообщение.
    
  2.3. EXACT ONCE - точно 1
    Появилась в кафке версии 4.0 и выше, благодаря распределенным транзакциям. 
    
КАК ГАРАНТИРУЕТСЯ ДОСТАВКА СООБЩЕНИЙ В СЛУЧАЕ, ЕСЛИ СЕРВЕР С КАФКОЙ УПАЛ?
- Кафка всегда запускается на кластере серверов, каждый из которых имеет свою копию кафки с теми же настройками.
- Когда продюсер отправляет сообщение, то оно сохраняется на каждой копии кафки

Масштабирование Кафки: - основное преимущество кафки!
1. Каждый топик разделен внутри себя на партишены. Каждый партишен хранит данные одного типа (своего топика).
2. Все сообщения от продюсера будут распределяться между партишенами равномерно
3. Порядок записи/чтения в/из партишенов СЛУЧАЙНЫ
4. При отправке сообщения ему можно задать ключ (например, json-поле), по которому сообщения будут распределяться по партишенам.
5. Партишены можно распределять между отдельными физическими серверами, что сильно повышает пропускную способность. 
 На самом деле на каждом сервере есть все партишены, каждый из которых получает копию сообщения от продюсера, однако консюмер получает сообщение только с одного партишена. 
 Таким образом у нас всегда есть копия, чтобы обеспечить гарантии доставки.
6. Более того, кафка отправляет продюсеру акноледжмент ТОЛЬКО если и основной партишен был обновлен, и его копия.

Нюанс - если сообщения отправляются на разные партишены, то консюмер может получить их в другом порядке (но есть возможность задать порядок следования).
Внутри партишена последовательность сообщений всегда сохраняется (очередь)
 
